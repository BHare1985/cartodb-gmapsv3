
<!doctype html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <title>CartoDB | Google Maps v3 library</title>
    <link href="http://developers.cartodb.com/stylesheets/all.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="../css/style.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="http://developers.cartodb.com/javascripts/all.js" type="text/javascript"></script>    
    <link rel="shortcut icon" href="http://developers.cartodb.com/images/favicon.ico" />
    <script type="text/javascript">
      var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-20934186-3']); _gaq.push(['_setDomainName', 'cartodb.com']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })();
    </script>
    <noscript><meta http-equiv="refresh" content="0;url=/no_javascript.html"></noscript>
  </head>
  <body class="developers examples" onload="initialize()">
    <div class="background blue grid fixed">
      <header>
        <h1 class="left">
          <a href="http://cartodb.com">CartoDB</a>
        </h1>
        <nav class="right">
          <a href="http://cartodb.com/tour">Tour</a>
          <a href="http://cartodb.com/maps">Maps</a>
          <a class="selected" href="http://developers.cartodb.com">Developers</a>
          <a href="http://cartodb.com/pricing">Pricing</a>
          <a href="http://cartodb.com/login">Sign in</a>
        </nav>
      </header>
    </div>

    <div class="background floating">
      <section class="shadow top">
        <div class="content">
         <hgroup><h2 class="dark">CartoDB Google Maps v3 - Query by distance</h2><em class="medium">MEDIUM</em></hgroup>
  
        </div>
        <div class="content no_padding border code">

          <link href="../css/cartodb-gmapsv3.css" rel="stylesheet" type="text/css">
          <link href="http://code.google.com/apis/maps/documentation/javascript/examples/default.css" rel="stylesheet" type="text/css" />          
          <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
          <script type="text/javascript" src="../js/wax.g.min-6.2.0-touched.js"></script>
          <script type="text/javascript" src="../dist/cartodb-gmapsv3-min.js"></script>

          <style type="text/css">
  .distance {
    position:absolute;
    width: 200px!important;
    top: 20px;
    right: 20px;
    z-index:100;
  }

          </style>

          <script type="text/javascript">
var
map     = null,
layer   = null,
overlay = null,
radius  = 300000,
radDeg  = 0,
lat     = 40.7248057566452,
lng     = -73.9967118782795;

var updateLayer = function(){

  var query = "SELECT * FROM {{table_name}} WHERE ST_Intersects (the_geom, ST_Buffer(ST_SetSRID('POINT(" + lng + " " + lat + ")'::geometry , 4326), " + getRagDeg(radius) + "))";

  if (layer) {
    layer.setOptions({query: query });
    return;
  }

  // Create layer
  layer = new CartoDBLayer({
    map: map,
    user_name: 'examples',
    table_name: 'points_na',
    query: query,
    layer_order: "top",
    tile_style: "#{{table_name}}{marker-fill:#F55; marker-line-color:#F55;}",
    interactivity: "cartodb_id"
  });
}

var getRagDeg = function(dist) {
  var deg = 180;
  var brng = deg * Math.PI / 180;
  dist = dist/6371000;
  var lat1 = lat * Math.PI / 180;
  var lon1 = lng * Math.PI / 180;
  var lat2 = Math.asin(Math.sin(lat1) * Math.cos(dist) +
                       Math.cos(lat1) * Math.sin(dist) * Math.cos(brng));
  var lon2 = lon1 + Math.atan2(Math.sin(brng) * Math.sin(dist) *
                               Math.cos(lat1),
  Math.cos(dist) - Math.sin(lat1) *
    Math.sin(lat2));
  if (isNaN(lat2) || isNaN(lon2)) return null;
  return lat - (lat2 * 180 / Math.PI) ;
}

function drawCircle() {

  if (overlay) {
    overlay.setMap(null);
  }

  overlay = new google.maps.Circle({
    map: map,
    center: new google.maps.LatLng(lat, lng),
    radius: radius,
    strokeColor: "#0000ff",
    strokeOpacity: 0.20,
    strokeWeight: 2,
    fillColor: "#0000ff",
    fillOpacity: 0.050
  });
}

function initialize() {

  // Create map
  map = new google.maps.Map(document.getElementById('map'), {
    center: new google.maps.LatLng(lat, lng),
    zoom: 4,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    mapTypeControl: false
  });

  // Styling
  map_style = [ { stylers: [ { saturation: -65 }, { gamma: 1.52 } ] }, { featureType: "administrative", stylers: [ { saturation: -95 },{ gamma: 2.26 } ] }, { featureType: "water", elementType: "labels", stylers: [ { visibility: "off" } ] }, { featureType: "administrative.locality", stylers: [ { visibility: 'off' } ] }, { featureType: "road", stylers: [ { visibility: "simplified" }, { saturation: -99 }, { gamma: 2.22 } ] }, { featureType: "poi", elementType: "labels", stylers: [ { visibility: "off" } ] }, { featureType: "road.arterial", stylers: [ { visibility: 'off' } ] }, { featureType: "road.local", elementType: "labels", stylers: [ { visibility: 'off' } ] }, { featureType: "transit", stylers: [ { visibility: 'off' } ] }, { featureType: "road", elementType: "labels", stylers: [ { visibility: 'off' } ] },{ featureType: "poi", stylers: [ { saturation: -55 } ] } ];
  map.setOptions({styles: map_style});

  updateLayer();
  drawCircle();

  $('input[type="range"]').mouseup(function(){
    radius = parseInt($(this).val());
    updateLayer();
    drawCircle();
  });

  $('input[type="range"]').change(function(){
    radius = parseInt($(this).val());
    drawCircle();
  })
}
          

          </script>
    <input type="range" class="distance" min="0" max="5000000" step="100000" value="300000" />
          <div id="map"></div>
          <span class="separator"></span>
        </div>
        <a class="back" href="http://developers.cartodb.com/">Back</a>
      </section>

      <section class="shadow leftwards bottom nav">
        <div class="content overflow">
          <div class="left">
            <h3 class="big">Overview</h3>
            <p class="light margin15">Use your CartoDB tables with a Google Maps v3 map.</p>
            <p class="light margin15"><a href="https://developers.google.com/maps/" target="_blank">Google Maps</a> has a wide array of APIs that let you embed the robust functionality and everyday usefulness of Google Maps into your own website and applications, and overlay your own data on top of them.</p>
            <p class="light margin15">The code is available on <a href="https://github.com/vizzuality/cartodb-gmapsv3" target="_blank">Github</a>. If you have any question there is a complete <a href="#documentation">documentation</a> or you can ask in the <a target="_blank" href="https://groups.google.com/forum/#!forum/cartodb">CartoDB mailing list</a>.</p>
          </div>
          <div class="right">
            <a class="button blue download" href="https://github.com/Vizzuality/cartodb-gmapsv3/zipball/gh-pages">Download this library</a>
            <h3 class="big margin40">Related resources</h3>
            <ul class="vt related">  
              <li><a href="http://developers.cartodb.com/documentation/cartodb-apis.html#maps_api">CartoDB Maps API</a></li>
              <li><a href="http://vizzuality.github.com/cartodb-leaflet">CartoDB Leaflet library</a></li>
              <li><a href="#custom-infowindow">CartoDB Google Maps v3 library with custom infowindow</a></li>
            </ul>
          </div>
        </div>
      </section>

      <section class="shadow margin40">
        <div class="content overflow">
          <h3 class="big" id="documentation">Documentation</h3>


        <div class="content less_padding">
          <div class="left">
            <h2 class="compact dark">Further info? Take a look a the docs</h2>
            <p class="light">Visit our support area and get some help from the community.</p>
          </div>
          <div class="right">
            <a class="button blue right margin5" href="http://developers.cartodb.com/documentation/using-cartodb.html">Go to documentation</a>
          </div>
        </div>
      </section>

      <div class="background white border margin40">
        <section>
          <div class="content less_padding">
            <div class="left">
              <h3 class="lighter margin10">CartoDB is also used by</h3>
            </div>
            <div class="right">
              <ul class="logos">
                <li><a class="unep-wcmc" target="_blank" href="http://www.unep-wcmc.org/"><img alt="UNEP-WCMC" title="UNEP-WCMC" src="http://developers.cartodb.com/images/logos/unep-wcmc.png" /></a></li>
                <li><a class="nasa" target="nasa" href="http://www.nasa.gov"><img alt="NASA" title="NASA" src="http://developers.cartodb.com/images/logos/nasa.png" /></a></li>
                <li><a class="diversity" target="_blank" href="http://www.cbd.int/"><img alt="Convention on Biological Diversity" title="Convention on Biological Diversity" src="http://developers.cartodb.com/images/logos/diversity.png" /></a></li>
                <li><a class="wsj" target="_blank" href="http://europe.wsj.com/home-page"><img alt="Wall Street Journal" title="Wall Street Journal" src="http://developers.cartodb.com/images/logos/wsj.png" /></a></li>
                <li><a class="wri" target="_blank" href="http://www.wri.org/"><img alt="WORLD RESOURCES INSTITUTE" title="WORLD RESOURCES INSTITUTE" src="http://developers.cartodb.com/images/logos/wri.png" /></a></li>
              </ul>
            </div>
          </div>
        </section>
      </div>


      <div class="background white border">
        <section>
          <div class="content no_padding">
            <ul class="hz">
              <li>
                <h3>Common questions</h3>
              </li>
              <li>
                <h3>Do you have any educational plans?</h3>
                <p class="light margin15">Yes we have. <a href="mailto:wadus@cartodb.com">Contact us</a> for getting more information. We are quite friends of academics so, you will get a lot of benefits.</p>
              </li>
              <li>
                <h3>Need something extra? Let us now.</h3>
                <p class="light margin15">Need us to help you with your visualization or application? Does your organization have unique requirements that don’t quite fit our plans? <a href="mailto:support@cartodb.com">Contact us</a>.</p>
              </li>
            </ul>
          </div>
        </section>
      </div>


      <footer>
        <div class="wrap">
          <span class="cartodb">CartoDB</span>
          <p class="lighter small left">CartoDB is a product of <a class="vizzuality" href="http://vizzuality.com">Vizzuality</a>
          </p>
          <nav class="right">
            <a href="http://cartodb.com/tour">Feature tour</a>
            <a href="http://cartodb.com/tutorial/step/1">Getting started</a>
            <a href="http://cartodb.com/maps">Maps</a>
            <a href="http://developers.cartodb.com/">Developers</a>
            <a href="http://blog.cartodb.com">Blog</a>
            <a href="http://cartodb.com/pricing">Pricing</a>
            <a href="mailto:support@cartodb.com">Contact</a>
          </nav>
        </div>
      </footer>
    </div>
  </body>
</html>
